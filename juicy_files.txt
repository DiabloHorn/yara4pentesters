rule ntds_file : usernames hashed_passwords active_directory windows passwords
{
    meta:
        author = "DiabloHorn https://diablohorn.com"
        description = "find the ntds.dit file"
    strings:
        $filemagic = {ef cd ab 89}
        $content_string = "Admin-Display-Name" nocase wide
        $content_string2 = "Address-Entry-Display-Table-MSDOS" nocase wide
        $content_string3 = "nTDSDSA-Display" nocase wide
        $content_string4 = "MSysObjects" nocase ascii
        $content_string5 = "ObjidTable" nocase ascii
    condition:
        ($filemagic at 4) and (int32(12) == 0 or int32(12) == 1) and all of ($content_*)
}

rule hive_file : usernames hashed_passwords registry windows passwords
{
    meta:
        author = "DiabloHorn https://diablohorn.com"
        description = "find registry hive files like system/security/sam"
    strings:
        $filemagic = "regf"
        $filemagicbin = "hbin"
        $content_string = "ROOT"
    condition:
        $filemagic at 0 and $filemagicbin at 4096 and $content_string
        
}

rule shadow_file : usernames hashed_passwords linux passwords
{
    meta:
        author = "DiabloHorn https://diablohorn.com"
        description = "find shadow files"
    strings:
        $rootline = /root:.:\d+?:\d+?:\d+?:\d+?:/ nocase
        $hashline = /:\$\d\$/
        $hashtype_md5 = ":$1$"
        $hashtype_blowfish = ":$2a$"
        $hashtype_blowfish2 = ":$2y$"
        $hashtype_sha256 = ":$5$"
        $hashtype_sha512 = ":$6$"
    condition:
        $rootline and $hashline and (1 of ($hashtype_*))
}

rule tomcat_file : usernames plain_passwords passwords
{
    meta:
        author = "DiabloHorn https://diablohorn.com"
        description = "find tomcat config file with plaintext passwords"
    strings:
        $xml_ident = "<tomcat-users>" nocase
        $xml_ident2 = "</tomcat-users>" nocase
        $roles = "<role rolename=" nocase
        $password_string = "username=" nocase
        $password_string2 = "password=" nocase
        $password_string3 = "roles=" nocase
    condition:
        all of them
}

rule mysql_file : usernames plain_passwords passwords
{
    meta:
        author = "DiabloHorn https://diablohorn.com"
        description = "find mysql config file with plaintext passwords"
    strings:
        $section_header = "[client]" nocase
        $creds_user = /user.{,10}?=/ nocase
        $creds_password = /password.{,10}?=/ nocase
    condition:
        all of them
}

rule unencrypted_private_key : plain_privatekey privatekey
{
    meta:
        author = "DiabloHorn https://diablohorn.com"
        description = "find unencrypted private keys"
    strings:
        $content = "-----BEGIN RSA PRIVATE KEY-----" nocase
        $content2 = "encrypted" nocase
    condition:
        $content at 0 and not $content2
}

rule encrypted_private_key : encrypted_privatekey privatekey
{
    meta:
        author = "DiabloHorn https://diablohorn.com"
        description = "find unencrypted private keys"
    strings:
        $content = "-----BEGIN RSA PRIVATE KEY-----" nocase
        $content2 = "encrypted" nocase
    condition:
        $content at 0 and $content2
}

